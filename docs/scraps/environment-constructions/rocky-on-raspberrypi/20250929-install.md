 # Rocky Linux を 外部ディスプレイ無しでラズパイにインストール
 # 目的
 ノートパソコン、USB、Raspberry Pi 4、ネットワーク環境、LAN線の少ない機器で、Rocky Linuxをセットアップする。
 
 # なぜ、Rocky Linux?
 Red Hat Enterprise Linux(RHEL)と、バグ間の互換性？があるように設計されたオープンソースらしいので。https://rockylinux.org/ja-JP

 # なぜ、ラズパイ？
 安い、静か、遅い（パフォーマンスチューニングのやりがいがある）

 # 使用環境
 - 作業OS：Windows11
 - インストールマシン：Raspberry Pi 4
 - インストールブロックデバイス：USB32GB
 - インストールOS：Rocky
 - LAN

 # 注意
 - 今回インストールするイメージのREADME`https://dl.rockylinux.org/pub/sig/10/altarch/aarch64/images/README.txt`（以下、RockyREADME）にもある通り、RockyLinuxは`Raspberry pi 3,2,1`で動作しません。

 - RockyREADMEにある通り、GUI

 # インストール
 1. Rockyの公式`https://rockylinux.org/ja-JP/download?arch=aarch64`から raspberrypi用のイメージをダウンロード
 
 2. Raspberry Pi Imager を使用してUSB（32GB）に書き込む。この際、WIFIの設定とSSHの設定を行う。WIFIはWindowsの設定などを参照し、ルーターの接続パスワードなどを設定した。SSHは過去に作成したSSHのパブリックキーを登録した。
 
 3. 書き込みが終了した後USBをラズパイに差し込み、電源をオン。（OSの入ったmicro sdカードが刺さっているとそちらが優先されるようなので注意）

 # SSH接続
 初期は、RockyREADMEにある通り、ユーザー名が`rocky`で、パスワードが`rockylinux`となってます。しかし、ホスト名がわからずSSH接続できません。よって、IP総当たりを行い接続を試みました。
 以下は手順です。
 
 1. ipconfigで現在のパソコンのIPを調べる。
 
 2. 割り当てされているIPが例えば`192.168.0.3`なら`192.168.0.X`を片っ端から接続しに行く。Xは2-255
 WSLが使えるなら以下のスクリプトで自動で行えます。
 
 ```sh
 #!/bin/bash

 ADDRESS=192.168.0.X # X は置換される

 for i in {2..255}; do
    printf '\r%s' $i
	if nc -w 1 ${ADDRESS/X/$i} 22; then
        echo ${ADDRESS/X/$i}
        break
    fi
 done
 ```

 # インストール直後の環境のログ
 ```
 [rocky@localhost ~]$ free -h
               total        used        free      shared  buff/cache   available
Mem:           7.6Gi       255Mi       7.3Gi        18Mi       238Mi       7.4Gi
Swap:          511Mi          0B       511Mi

[rocky@localhost ~]$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda3       1.7G  1.2G  401M  75% /
devtmpfs        4.0M     0  4.0M   0% /dev
tmpfs           3.9G     0  3.9G   0% /dev/shm
tmpfs           1.6G   19M  1.6G   2% /run
tmpfs           1.0M     0  1.0M   0% /run/credentials/systemd-journald.service
/dev/sda1       500M   88M  413M  18% /boot/efi
tmpfs           1.0M     0  1.0M   0% /run/credentials/getty@tty1.service
tmpfs           781M  4.0K  781M   1% /run/user/1000

[rocky@localhost ~]$ top -bn1 | head -n20
top - 20:39:42 up  1:42,  2 users,  load average: 0.03, 0.10, 0.10
Tasks: 138 total,   1 running, 137 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  4.1 sy,  0.0 ni, 95.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   7809.4 total,   7426.7 free,    258.8 used,    239.3 buff/cache
MiB Swap:    512.0 total,    512.0 free,      0.0 used.   7550.6 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   1895 rocky     20   0  231804   4608   2688 R  15.4   0.1   0:00.04 top
      1 root      20   0   43460  34428   9692 S   0.0   0.4   0:05.38 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.01 kthreadd
      3 root      20   0       0      0      0 S   0.0   0.0   0:00.00 pool_wo+
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      5 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      6 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      7 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
      9 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
     11 root      20   0       0      0      0 I   0.0   0.0   0:00.05 kworker+
     12 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker+
     13 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tas+
     14 root      20   0       0      0      0 I   0.0   0.0   0:00.00 rcu_tas+
 ```

 # 後処理
 RockyREADMEにある通り、`/`の容量が実際の容量よりかなり少ないので、以下のコマンドを実行する。
 ```
 sudo rootfs-expand
 ```
 ```
 2025-09-28 20:44:10 - Starting rootfs-expand
2025-09-28 20:44:11 - Extending partition 3 on device /dev/sda to maximum size...
CHANGED: partition=3 start=2074624 old: size=3616735 end=5691358 new: size=58485983 end=60560606
2025-09-28 20:44:12 - Resizing filesystem on ...
resize2fs 1.47.1 (20-May-2024)
Filesystem at /dev/sda3 is mounted on /; on-line resizing required
old_desc_blocks = 1, new_desc_blocks = 4
The filesystem on /dev/sda3 is now 7310747 (4k) blocks long.

2025-09-28 20:44:23 - Done.
/dev/sda3        28G  1.2G   26G   5% /
```
コマンドの結果より、およそ28GBに増えたことがわかる。

 # 所感
 楽しかった。動いてうれしい。ユーザーが特権持ていて、あまりうれしくないので、sudoersをいじってコマンドを最小限にできると良いのかなという印象。やるとは言ってない。docker入れて、samba入れたいかもなと思っている。
